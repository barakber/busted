#!/usr/bin/env bash
set -e

# Create eBPF stub if not built (needed for include_bytes in busted-agent)
mkdir -p target/bpfel-unknown-none/debug target/bpfel-unknown-none/release
[ -f target/bpfel-unknown-none/debug/busted-ebpf ] || touch target/bpfel-unknown-none/debug/busted-ebpf
[ -f target/bpfel-unknown-none/release/busted-ebpf ] || touch target/bpfel-unknown-none/release/busted-ebpf

echo "==> cargo fmt --check"
cargo fmt --all -- --check

echo "==> clippy (default features)"
cargo clippy --workspace --exclude busted-ebpf -- -D warnings

echo "==> clippy (all agent features)"
cargo clippy -p busted-agent --features ml,tls,prometheus -- -D warnings

echo "All checks passed."
