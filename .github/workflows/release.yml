name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g. 0.2.0)"
        required: true
      dry_run:
        description: "Dry run (skip actual publish)"
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always
  BUSTED_SKIP_EBPF_BUILD: "1"

jobs:
  ci-gate:
    name: CI Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Format check
        run: cargo fmt --all -- --check
      - name: Clippy
        run: cargo clippy --workspace --exclude busted-ebpf -- -D warnings
        env:
          RUSTFLAGS: -Dwarnings
      - name: Test
        run: cargo test --workspace --exclude busted-ebpf
      - name: Version check
        run: cargo xtask version-check

  verify:
    name: Verify Version
    runs-on: ubuntu-latest
    needs: ci-gate
    outputs:
      version: ${{ steps.extract.outputs.version }}
      dry_run: ${{ steps.extract.outputs.dry_run }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Extract version
        id: extract
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            DRY_RUN="false"
          else
            VERSION="${{ github.event.inputs.version }}"
            DRY_RUN="${{ github.event.inputs.dry_run }}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "dry_run=$DRY_RUN" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION, Dry run: $DRY_RUN"
      - name: Verify workspace version matches
        run: |
          WORKSPACE_VERSION=$(cargo metadata --no-deps --format-version=1 | \
            jq -r '.packages[] | select(.name == "busted-types") | .version')
          if [ "$WORKSPACE_VERSION" != "${{ steps.extract.outputs.version }}" ]; then
            echo "ERROR: Tag version (${{ steps.extract.outputs.version }}) does not match workspace version ($WORKSPACE_VERSION)"
            exit 1
          fi
          echo "Version verified: $WORKSPACE_VERSION"

  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: verify
    if: needs.verify.outputs.dry_run == 'false'
    environment: crates-io
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: "Tier 1: busted-types, busted-classifier"
        run: |
          cargo publish -p busted-types
          cargo publish -p busted-classifier
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for crates.io index update
        run: sleep 30

      - name: "Tier 2: busted-ebpf, busted-ml, busted-opa, busted-ui"
        run: |
          cargo publish -p busted-ebpf --no-verify
          cargo publish -p busted-ml
          cargo publish -p busted-opa
          cargo publish -p busted-ui
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for crates.io index update
        run: sleep 30

      - name: "Tier 3: busted-agent"
        run: cargo publish -p busted-agent --no-verify
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for crates.io index update
        run: sleep 30

      - name: "Tier 4: busted (CLI)"
        run: cargo publish -p busted
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [verify, publish]
    if: github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Create GitHub Release
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --generate-notes
        env:
          GH_TOKEN: ${{ github.token }}
